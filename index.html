<!DOCTYPE html>
<html>
<head>
    <title>Tic Tac Toe</title>
    <link rel="stylesheet" href="styles/main.css" >
    <link rel="stylesheet" href="styles/tooltip.css" />
</head>
<body>
   
    <div id='header'>
        <button id='toggleTips' >Show tips</button>
        <p>Total score:</p>
    </div>
    <board id='board'></board>
   
    <script>
        let b = {
            board: [],
            r: 10,
            c: 10
        }
        const cells = document.getElementsByTagName('cell')
        function initBoard(){
            for(let i=0; i<b.r*b.c; ++i)
                b.board.push(0)
        }
        initBoard()
        const boardPl = () =>  `b([${b.board.join(',')}], ${b.r}, ${b.c})`

        const makeMove = (r, c, pl,res) => `makeEvalMove(${boardPl()},m(${r+1},${c+1}),${pl},${res})`
        


        function getColor(score){
            const mainColor = [255, 235, 205]
            let coeff = 0
            let maxCoeff = 6
            for(let i=maxCoeff; i>1; --i){
                if(Math.pow(10,i) < score){
                    coeff = i - 2
                    break
                }
            }
            return  score==0 ? `rgb(${mainColor.join()})` : `rgb(${mainColor.map(c => c*(1- coeff/maxCoeff) ).join()})`
        }

        function changeRowColor(r, cols){
            for(let c=0; c<b.c; ++c){
                let color = getColor(cols[c])
                cells[r*b.c + c].style.backgroundColor = color
            }
        }
        

        function changeColors(){
            for(let r=0; r<b.r; ++r){
                let row = Array.from(Array(b.c).keys())
                let query = `{
                    "query": "${row.map(c => makeMove(r,c,'x','Score'+r+c)).join()}",
                    "goals": "${row.map(c => 'writeln(Score'+r+c+')').join()}"
                    }`
                let xhttp = new XMLHttpRequest()
                xhttp.open("POST", "/pl", true)
                xhttp.setRequestHeader("Content-Type", "application/json");
                xhttp.send(query)
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        let arr = this.responseText.split('\n')
                        changeRowColor(r, arr)
                    }
                };
            }
            
        }

        function score(r, c, elem){
            // evalMove(B, Mv, Pl, Score) 
            let query = `{
                "query": "${makeMove(r,c,'x','ScorePlayer')}, ${makeMove(r,c,'x','ScoreAI')}",
                "goals": "writeln(ScorePlayer), writeln(ScoreAI)"
                }`
            let xhttp = new XMLHttpRequest()
            xhttp.open("POST", "/pl", true)
            xhttp.setRequestHeader("Content-Type", "application/json");
            xhttp.send(query)
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let arr = this.responseText.split('\n')
                    elem.innerText = `User score:${arr[0]}\nAI score:${arr[1]}`
                }
            };
           
        }
        
    </script>
     <script src="scripts/main.js"></script>
</body>

</html>